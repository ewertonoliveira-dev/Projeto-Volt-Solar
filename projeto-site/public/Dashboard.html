<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard</title>

    <link rel="stylesheet" href="Dashboard.css">
    <link rel="stylesheet" href="css/menu_e_rodape.css">

    <!-- scripts do Chart.js -->
    <script type="text/javascript" src="https://www.chartjs.org/dist/2.8.0/Chart.min.js"></script>
    <script type="text/javascript" src="https://www.chartjs.org/samples/latest/utils.js"></script>
    <script type="text/javascript" src="funcoes.js"></script>

</head>
<body>
    
    <!-- Header -->
    <div class="corpo" style="display: none;" id="dashdash">
        <div class="grafico fechar" id="dashzin" onclick="fechar()">
                Perfil
            </div>
        <div class="dashb">
            
            <div class="titulo_dash">
                <h1>Dashboard</h1>
            </div>

            <div>
                <a href="tempo-real.html" class="real">Tempo Real</a>
            </div>
            
            
            <!-- Boxes -->

            <div class="conteudo">
                <div class="container">
                    <div class="boxes">
                        <button onclick="Rede()" class="box one">
                            Fábrica 1
                        </button>
                        <button onclick="Rede()" class="box two">
                            Fábrica 2
                        </button>
                        <button onclick="Rede()" class="box three">
                            Fábrica 3
                        </button>
                    </div>
                </div>
            </div>

            <!-- Conteudo 2 -->

            <div id="conteudo_2" style="display: none;" class="conteudo2">
                <div class="container">
                    <div class="boxes">
                        <button onclick="Setor()" class="box one">
                            Setor 1
                        </button>
                        <button onclick="Setor()" class="box two">
                            Setor 2
                        </button>
                        <button onclick="Setor()" class="box three">
                            Setor 3
                        </button>
                    </div>
                </div>
            </div>

            <!-- Conteudo 3 -->

            <div id="conteudo_3" style="display: none;" class="conteudo3">
                <div class="container">
                    <div class="boxes">
                        <button onclick="Placa()" class="box one">
                            Placa 1
                        </button>
                        <button onclick="Placa()" class="box two">
                            Placa 2
                        </button>
                        <button onclick="Placa()" class="box three">
                            Placa 3
                        </button>
                    </div>
                </div>
            </div>

            <!-- Gráficos -->

            <div id="grafico_sensor" style="display: none;" class="graficos">
                <div class="container">
                
                    <!-- Esquerda -->

                <div class="esquerda">
                    <div class="caixa">
                        
                    </div>
                </div>

                <!-- Direita -->

                <div class="direita">
                    <div class="caixa">
                        
                        <div style="width:75%;">
                            <div id="div_aguarde">Dados sendo obtidos...</div>
                            <canvas id="canvas_grafico"></canvas>
                        </div>
                    
                    </div>
                </div>

                </div>
            </div>
        </div>
    </div>
    <div class="header" id="menu">
        <div class="container">
            <div class="titulo"><img width="100%" height="60px" src="icones/logo.png" alt="">
                <a href="#">VoltSolar</a>
            </div>

            <div class="nav">
                <ul>
                    <li><a href="index.html">início</a></li>
                    <li><a href="servicos.html">serviços</a></li>
                    <li><a href="sobre.html">sobre</a></li>
                    <li><a href="contato.html">contato</a></li>
                    <li>|</li>
                    <li class="botao_login"><a href="#" onclick="logoff()">Sair</a></li>
                </ul>
            </div>
        </div>
    </div>

    <!-- Perfil -->
    <div class="content">
        <b>
        <div class="esquerdo">
            <img id="imagem_perfil" src="icones/perfil.jpg" alt="imagem de perfil" class="perfilimg">
            <p>
                Nome: <span id="nome"><b id="b_usuario"></b></span>
            </p>
        </div>
        <div class="direita">
            <p>
                Sensores: <span id="sensores"></span>
            </p>
            <p>
                Setores: <span id="setores"></span>
            </p>
        </div>
        </b>
    </div>  
    
    <div class="grafico abrir" id="dashboard" onclick="abrir()">
        Dashboard
    </div>
    <!-- rodapé -->

    <div class="rodape">
        <div class="container">
          <p> VoltSolar Copyright © 2020 </p>
        </div>
      </div>

</body>
</html>
<script>

    function Rede(){

        conteudo_2.style.display='block';

    }
    function Setor(){

        conteudo_3.style.display='block';

    }
    function Placa(){

        grafico_sensor.style.display='block';

    }

    function verificar_autenticacao() {
    login_usuario = sessionStorage.login_usuario_meuapp;
    nome_usuario = sessionStorage.nome_usuario_meuapp;
    imagem_usuario = sessionStorage.imagem_usuario_meuapp;
    
    if (login_usuario == undefined)  {
        redirecionar_login();
    } else {
        b_usuario.innerHTML = nome_usuario;
        imagem_perfil.src = imagem_usuario;
        validar_sessao();
    }
    
    }

    function logoff() {
    finalizar_sessao();
    sessionStorage.clear();
    redirecionar_login();
    window.location.href = 'index.html';
    }

    window.onload = obterDadosGrafico;
    
    verificar_autenticacao();

    
// neste JSON tem que ser 'labels', 'datasets' etc, 
// porque é o padrão do Chart.js
var dados = {
    labels: [],
    datasets: [
        {
            yAxisID: 'y-temperatura',
            label: 'Sensor 1',
            borderColor: window.chartColors.red,
            backgroundColor: window.chartColors.red,
            fill: false,
            data: []
        },
        {
            yAxisID: 'y-umidade',
            label: 'Sensor 2',
            borderColor: window.chartColors.blue,
            backgroundColor: window.chartColors.blue,
            fill: false,
            data: []
        }
    ]
};


// só mexer se quiser alterar o tempo de atualização
// ou se souber o que está fazendo!
function atualizarGrafico() {

    fetch('/leituras/tempo-real', { cache: 'no-store' }).then(function (response) {
        if (response.ok) {
            response.json().then(function (novoRegistro) {

                console.log(`Dados recebidos: ${JSON.stringify(novoRegistro)}`);
                
                // tirando e colocando valores no gráfico
                dados.labels.shift(); // apagar o primeiro
                dados.labels.push(novoRegistro.momento_grafico); // incluir um novo momento
                dados.datasets[0].data.shift();  // apagar o primeiro de temperatura
                dados.datasets[1].data.shift();  // apagar o primeiro de umidade
                dados.datasets[0].data.push(novoRegistro.captacao); // incluir uma nova leitura de temperatura
                dados.datasets[1].data.push(novoRegistro.posicao); // incluir uma nova leitura de umidade
                window.grafico_linha.update();
                
                setTimeout(atualizarGrafico, 5000);
            });
        } else {
            console.error('Nenhum dado encontrado ou erro na API');
            setTimeout(atualizarGrafico, 5000);
        }
    })
    .catch(function (error) {
        console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
    });
    
}

// altere aqui as configurações do gráfico
// (tamanhos, cores, textos, etc)
function configurarGrafico() {
    var configuracoes = {
        responsive: true,
        animation: {duration: 500},
        hoverMode: 'index',
        stacked: false,
        title: {
            display: true,
            text: 'Histórico recente de Luminosidade e posição'
        },
        scales: {
            yAxes: [{
                type: 'linear', // only linear but allow scale type registration. This allows extensions to exist solely for log scale for instance
                display: true,
                position: 'left',
                id: 'y-temperatura',
            }, {
                type: 'linear', // only linear but allow scale type registration. This allows extensions to exist solely for log scale for instance
                display: true,
                position: 'right',
                id: 'y-umidade',

                // grid line settings
                gridLines: {
                    drawOnChartArea: false, // only want the grid lines for one axis to show up
                },
            }],
        }
    };

    return configuracoes;
}

// altere aqui como os dados serão exibidos
// e como são recuperados do BackEnd
function obterDadosGrafico() {

    fetch('/leituras/ultimas', { cache: 'no-store' }).then(function (response) {
        if (response.ok) {
            response.json().then(function (resposta) {

                console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);

                resposta.reverse();

                for (i = 0; i < resposta.length; i++) {
                    var registro = resposta[i];
                
                    // aqui, após 'registro.' use os nomes 
                    // dos atributos que vem no JSON 
                    // que gerou na consulta ao banco de dados

                    dados.labels.push(registro.momento_grafico);

                    dados.datasets[0].data.push(registro.captacao);
                    dados.datasets[1].data.push(registro.posicao);
                }
                console.log(JSON.stringify(dados));

                div_aguarde.style.display = 'none';

                plotarGrafico(dados);
            });
        } else {
            console.error('Nenhum dado encontrado ou erro na API');
        }
    })
    .catch(function (error) {
        console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
    });

}

// só altere aqui se souber o que está fazendo!
function plotarGrafico(dados) {
    console.log('iniciando plotagem do gráfico...');

    var ctx = canvas_grafico.getContext('2d');
    window.grafico_linha = Chart.Line(ctx, {
        data: dados,
        options: configurarGrafico()
    });

    setTimeout(atualizarGrafico, 5000);
}
    function abrir(){
        dashdash.style.display = `block`
        document.getElementById("dashdash").classList.add("animationopen")
        document.getElementById("dashdash").classList.remove("animationclose")
        setTimeout(function(){ dashboard.style.display = `none`;}, 600)
    }
    function fechar(){
        document.getElementById("dashdash").classList.remove("animationopen")
        document.getElementById("dashdash").classList.add("animationclose")
        setTimeout(function(){ dashboard.style.display = `block`;
        dashdash.style.display = `none`}, 450)
    }
</script>